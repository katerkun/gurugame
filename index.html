import React, { useState, useEffect, useRef } from 'react';
import { Download, Lock, Music } from 'lucide-react';

// --- RUTAS DE ARCHIVOS EN LA RAÃZ ---
const IMG_CLOSED = "librocerrado.png"; 
const IMG_OPENING = "libroabierto.png"; 
const IMG_OPEN_BOOK = "libro.png"; 
const IMG_NIKE = "nike.png"; 
const IMG_KUKURI = "kukuri.png"; 
const AUDIO_BGM = "bgm.mp3"; 

// Archivos para descargar
const FILE_DEMO = "CircleOfLove_Demo.zip";
const FILE_BONUS = "CircleOfLove_Bonus.zip";

// URLs de respaldo para previsualizaciÃ³n
const FALLBACK_NIKE = "http://googleusercontent.com/image_generation_content/0";
const FALLBACK_KUKURI = "http://googleusercontent.com/image_generation_content/1";

// --- ESTILOS CSS INYECTADOS ---
const globalStyles = `
  @import url('https://fonts.googleapis.com/css2?family=Indie+Flower&family=VT323&display=swap');

  :root {
      --color-primary: #ff7eb3;
      --color-secondary: #7afcff;
      --color-accent: #ffeb3b;
      --color-text: #4a0e4e;
  }

  body {
      font-family: 'VT323', monospace;
      background-color: #1a1a2e;
      overflow: hidden;
      margin: 0;
      padding: 0;
      color: var(--color-text);
  }

  .handwritten {
      font-family: 'Indie Flower', cursive;
  }

  .immersive-bg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
      filter: blur(15px) brightness(0.5);
      transform: scale(1.1); 
      z-index: 0;
      transition: background-image 1s ease-in-out;
  }

  /* --- CAJA DEL LIBRO (3072x1728) --- */
  .aspect-ratio-box {
      position: relative;
      width: 100%;
      max-width: 3072px; /* Ancho actualizado */
      aspect-ratio: 3072 / 1728; /* ProporciÃ³n actualizada */
      max-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
  }

  .book-image {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      transition: opacity 0.8s ease-in-out;
  }

  .book-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      width: 84%;
      height: 75%;
      column-gap: 5%;
      position: relative;
      z-index: 20;
      margin-bottom: 2%; 
  }

  .bg-interactive {
      pointer-events: auto;
      cursor: pointer;
      transition: transform 0.3s ease;
  }
  .bg-interactive:hover {
      transform: scale(1.02);
      filter: drop-shadow(0 0 15px rgba(255, 235, 59, 0.5));
  }

  .float-book { animation: floatBook 6s ease-in-out infinite; }
  @keyframes floatBook {
      0%, 100% { transform: translateY(0%); }
      50% { transform: translateY(-1%); }
  }

  .sparkle {
      position: absolute;
      color: #FFD700;
      font-size: 20px;
      pointer-events: none;
      animation: sparkleAnim 2.5s infinite linear;
      opacity: 0;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.8);
  }
  @keyframes sparkleAnim {
      0% { transform: scale(0) translate(0, 0) rotate(0deg); opacity: 0; }
      20% { opacity: 1; }
      100% { transform: scale(1.2) translate(var(--tx), var(--ty)) rotate(45deg); opacity: 0; }
  }

  .bounce-char { animation: bounce 2s infinite; }
  @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
  }

  .rpg-btn {
      background: #3b82f6;
      border: 3px solid #1d4ed8;
      box-shadow: inset 3px 3px 0px rgba(255,255,255,0.3), inset -3px -3px 0px rgba(0,0,0,0.3);
      transition: all 0.1s;
  }
  .rpg-btn:active { transform: translateY(2px); box-shadow: none; }
  .rpg-btn:hover { filter: brightness(1.1); }

  .mystic-input {
      border: none;
      border-bottom: 4px solid rgba(255, 215, 0, 0.7);
      background: transparent;
      text-align: center;
      font-family: 'VT323', monospace;
      color: #FFD700;
      font-weight: bold;
      font-size: 3rem;
      letter-spacing: 0.2em;
      outline: none;
      transition: all 0.3s;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.8), 0 0 20px rgba(255, 100, 0, 0.5);
      width: 100%;
      max-width: 400px;
  }
  .mystic-input:focus {
      border-bottom-color: #fff;
      transform: scale(1.05);
  }
  .mystic-input::placeholder {
      color: rgba(255, 215, 0, 0.3);
      font-size: 2rem;
      letter-spacing: 0.1em;
  }

  @media (max-width: 768px) {
      .aspect-ratio-box {
          width: 95%;
          aspect-ratio: auto;
          height: auto;
          background: rgba(255,255,255,0.9);
          border-radius: 10px;
          padding: 10px;
      }
      .book-image { display: none; }
      .book-grid {
          width: 100%;
          height: auto;
          grid-template-columns: 1fr;
          gap: 20px;
          margin-bottom: 0;
      }
  }
`;

// --- COMPONENTES ---

const DownloadIcon = () => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="square" strokeLinejoin="miter"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
);

const InvocationSpiral = ({ onClick, isInvoking }) => (
    <div 
        onClick={onClick} 
        className={`relative cursor-pointer transition-all duration-700 group flex flex-col items-center justify-center w-full h-full ${isInvoking ? 'scale-110 brightness-125' : 'hover:scale-105'}`}
    >
        <div className="relative w-72 h-72 md:w-96 md:h-96">
            <svg viewBox="0 0 200 200" className="w-full h-full drop-shadow-2xl">
                {/* Anillo de Runas Exterior (Gira lento) */}
                <circle cx="100" cy="100" r="90" fill="none" stroke="#d63031" strokeWidth="1" strokeDasharray="4,6" className={`opacity-60 ${isInvoking ? 'animate-[spin_1s_linear_infinite]' : 'animate-[spin_20s_linear_infinite]'}`} />
                <circle cx="100" cy="100" r="85" fill="none" stroke="#4a0e4e" strokeWidth="2" opacity="0.4" />
                
                {/* CÃ­rculo Medio (Gira opuesto) */}
                <g className={isInvoking ? 'animate-[spin_1s_linear_infinite_reverse]' : 'animate-[spin_15s_linear_infinite_reverse]'}>
                    <circle cx="100" cy="100" r="70" fill="none" stroke="#d63031" strokeWidth="2" />
                    <path d="M100 30 L100 170 M30 100 L170 100" stroke="#d63031" strokeWidth="1" opacity="0.5" />
                    <rect x="65" y="65" width="70" height="70" fill="none" stroke="#d63031" strokeWidth="1" transform="rotate(45 100 100)" opacity="0.6"/>
                </g>

                {/* Espiral Central (Gira rÃ¡pido) */}
                <g className={isInvoking ? 'animate-[spin_0.2s_linear_infinite] text-yellow-400' : 'animate-[spin_6s_linear_infinite] text-[#d63031]'}>
                    <path 
                        fill="none" 
                        stroke="currentColor" 
                        strokeWidth="5" 
                        strokeLinecap="round"
                        d="M100 100 m 0 -8 a 8 8 0 1 1 0 16 a 16 16 0 1 1 0 -32 a 24 24 0 1 1 0 48 a 32 32 0 1 1 0 -64 a 40 40 0 1 1 0 80" 
                    />
                </g>
            </svg>
            
            {/* Texto central flotante */}
            <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                <span className={`font-bold text-3xl text-[#4a0e4e] bg-white/90 px-6 py-2 rounded-full backdrop-blur-md shadow-[0_0_20px_rgba(214,48,49,0.5)] border-2 border-[#d63031] ${isInvoking ? 'opacity-0 scale-150' : 'opacity-100 scale-100'} transition-all duration-300`}>
                    INVOCAR
                </span>
            </div>
        </div>
        <p className={`mt-4 handwritten text-2xl text-[#d63031] font-bold text-center bg-white/70 px-6 py-2 rounded-lg shadow-lg ${isInvoking ? 'animate-pulse' : ''}`}>
            {isInvoking ? "Â¡INVOCANDO PODER...!" : "Toca el CÃ­rculo MÃ¡gico"}
        </p>
    </div>
);

const FullMagicSeal = ({ password, setPassword, onSubmit, error }) => (
    <div className="relative w-full h-full flex flex-col items-center justify-center animate-[fadeIn_0.5s_ease-out]">
        
        {/* Fondo MÃ¡gico Rotatorio - GIGANTE */}
        <div className="absolute inset-0 flex items-center justify-center pointer-events-none opacity-40">
            <svg viewBox="0 0 200 200" className="w-[220%] h-[220%] text-[#4a0e4e] animate-[spin_60s_linear_infinite]">
                <circle cx="100" cy="100" r="90" fill="none" stroke="currentColor" strokeWidth="0.5" strokeDasharray="5,5" />
                <path d="M100 10 L190 100 L100 190 L10 100 Z" fill="none" stroke="currentColor" strokeWidth="0.5" />
                <circle cx="100" cy="100" r="50" fill="none" stroke="#d63031" strokeWidth="1" opacity="0.5" />
                <circle cx="100" cy="100" r="70" fill="none" stroke="currentColor" strokeWidth="0.2" />
                <circle cx="100" cy="100" r="110" fill="none" stroke="currentColor" strokeWidth="0.2" opacity="0.3" /> 
            </svg>
        </div>

        {/* Elementos Centrales Flotantes */}
        <div className="relative z-10 flex flex-col items-center w-full max-w-2xl">
            
            {/* Icono de Candado Flotante */}
            <div className="text-8xl mb-2 filter drop-shadow-[0_0_20px_rgba(255,215,0,0.8)] animate-bounce">ðŸ”’</div>
            
            <h2 className="text-4xl text-[#FFD700] font-bold mb-8 font-serif tracking-[0.2em] text-shadow-lg drop-shadow-md">
                SELLO SAGRADO
            </h2>
            
            <form onSubmit={onSubmit} className="w-full flex flex-col items-center gap-6">
                <div className="relative w-full flex justify-center">
                    <input 
                        type="text" 
                        value={password} 
                        onChange={(e) => setPassword(e.target.value)} 
                        placeholder="PALABRA MÃGICA" 
                        className="mystic-input uppercase"
                        autoFocus
                    />
                    {/* Brillos decorativos alrededor del input */}
                    <div className="absolute -right-4 top-2 text-yellow-400 text-2xl animate-pulse">âœ¨</div>
                    <div className="absolute -left-4 bottom-2 text-yellow-400 text-xl animate-pulse delay-100">âœ¨</div>
                </div>
                
                {error && (
                    <div className="text-[#ff9a9e] font-bold text-xl text-shadow animate-[bounce_0.5s_infinite]">
                        âš¡ Â¡LA MAGIA RECHAZA ESA PALABRA! âš¡
                    </div>
                )}
                
                {/* INDICADOR DE AYUDA (SIN BOTÃ“N) */}
                <p className="text-white/70 text-sm tracking-widest font-bold mt-8 animate-pulse bg-black/30 px-4 py-2 rounded-full border border-white/10">
                    [ PRESIONA ENTER PARA ROMPER EL SELLO ]
                </p>
            </form>
        </div>
    </div>
);

const FinalSpiral = ({ onClick, isCollecting }) => (
    <div 
        onClick={onClick} 
        className={`relative cursor-pointer transition-all duration-700 group flex flex-col items-center justify-center w-full h-full ${isCollecting ? 'scale-110 opacity-80' : 'hover:scale-105'}`}
    >
        <div className="relative w-72 h-72 md:w-96 md:h-96">
            <svg 
                viewBox="0 0 100 100" 
                className={`w-full h-full text-pink-500 drop-shadow-[0_0_25px_rgba(255,105,180,0.6)] ${isCollecting ? 'animate-[spin_0.2s_linear_infinite]' : 'animate-[spin_12s_linear_infinite]'}`}
                fill="none" 
                stroke="currentColor" 
                strokeWidth="3" 
                strokeLinecap="round"
            >
                <circle cx="50" cy="50" r="48" stroke="#FFD700" strokeWidth="1" strokeDasharray="2,2" />
                <path d="M50 50 m 0 -5 a 5 5 0 1 0 0 10 a 10 10 0 1 0 0 -20 a 20 20 0 1 0 0 40 a 30 30 0 1 0 0 -60" opacity="0.9"/>
                <g stroke="#FFD700" strokeWidth="2">
                    <path d="M50 5 L50 20" />
                    <path d="M50 80 L50 95" />
                    <path d="M5 50 L20 50" />
                    <path d="M80 50 L95 50" />
                    <path d="M18 18 L28 28" />
                    <path d="M72 72 L82 82" />
                    <path d="M18 82 L28 72" />
                    <path d="M72 28 L82 18" />
                </g>
                <circle cx="50" cy="50" r="8" fill="#FFD700" className="animate-pulse"/>
            </svg>
            
            <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                <span className={`font-bold text-3xl text-white bg-gradient-to-r from-pink-500 to-purple-600 px-8 py-3 rounded-full shadow-[0_5px_15px_rgba(0,0,0,0.3)] border-4 border-[#FFD700] tracking-widest transform transition-transform ${isCollecting ? 'scale-0' : 'scale-100'}`}>
                    TESORO
                </span>
            </div>
        </div>
        <p className="mt-6 handwritten text-2xl text-[#e91e63] font-bold bg-white/80 px-6 py-2 rounded-lg shadow-lg backdrop-blur-sm">
            {isCollecting ? "âœ¨ Â¡RECOGIENDO MAGIA! âœ¨" : "Toca para Guardar"}
        </p>
    </div>
);

const TypewriterText = ({ text, delay = 40, className }) => {
    const [displayText, setDisplayText] = useState('');
    useEffect(() => {
        let i = 0; setDisplayText('');
        const timer = setInterval(() => {
            if (i < text.length) { setDisplayText(p => p + text.charAt(i)); i++; } 
            else clearInterval(timer);
        }, delay);
        return () => clearInterval(timer);
    }, [text]);
    return <p className={className}>{displayText}</p>;
};

const Sparkles = () => {
    const sparkles = Array.from({ length: 15 }).map((_, i) => ({
        id: i,
        left: 10 + Math.random() * 80 + '%',
        top: 10 + Math.random() * 80 + '%',
        tx: (Math.random() - 0.5) * 100 + 'px',
        ty: (Math.random() - 1) * 100 + 'px',
        delay: Math.random() * 2 + 's',
        color: Math.random() > 0.5 ? '#FFD700' : '#FF69B4',
        size: Math.random() * 12 + 8 + 'px'
    }));
    return (
        <div className="absolute inset-0 pointer-events-none overflow-hidden z-30">
            {sparkles.map(s => (
                <div key={s.id} className="sparkle" style={{
                    left: s.left, top: s.top, '--tx': s.tx, '--ty': s.ty, 
                    animationDelay: s.delay, color: s.color, fontSize: s.size
                }}>âœ¨</div>
            ))}
        </div>
    );
};

const TreasureChest = () => (
     <svg className="bounce-char mx-auto drop-shadow-md" width="100" height="100" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M20 50 L80 50 L75 80 L25 80 Z" fill="#FBC02D" stroke="#2d1b2e" strokeWidth="4" strokeLinejoin="round"/>
        <path d="M15 40 Q50 20 85 40 L80 50 L20 50 Z" fill="#FDD835" stroke="#2d1b2e" strokeWidth="4" strokeLinejoin="round"/>
        <circle cx="50" cy="55" r="6" fill="#2d1b2e"/>
        <circle cx="50" cy="55" r="3" fill="#F44336"/>
        <path d="M30 40 L35 30 L40 40 Z" fill="#00E676" />
        <path d="M60 40 L65 25 L70 40 Z" fill="#2979FF" />
    </svg>
);

// --- APP PRINCIPAL ---
export default function App() {
    const [stage, setStage] = useState('closed'); 
    const [password, setPassword] = useState('');
    const [error, setError] = useState(false);
    const [isPlaying, setIsPlaying] = useState(false);
    const [isInvoking, setIsInvoking] = useState(false);
    const [isCollecting, setIsCollecting] = useState(false);
    const audioRef = useRef(null);
    const SECRET_CODE = "GURU"; 

    const currentBg = stage === 'closed' ? IMG_CLOSED : (stage === 'opening' ? IMG_OPENING : IMG_OPEN_BOOK);

    useEffect(() => {
        if (isPlaying && audioRef.current) {
            audioRef.current.volume = 0.3;
            const playPromise = audioRef.current.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => console.log("Audio autoplay block"));
            }
        }
    }, [isPlaying]);

    const handleStart = () => {
        if (stage === 'closed') {
            setIsPlaying(true);
            setStage('opening');
            setTimeout(() => setStage('scene1'), 2500);
        }
    };

    const handleSpiralClick = () => {
        if (isInvoking) return;
        setIsInvoking(true);
        setTimeout(() => {
            const link = document.createElement('a');
            link.href = FILE_DEMO; 
            link.setAttribute('download', FILE_DEMO);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            setStage('password');
            setIsInvoking(false);
        }, 1500);
    };

    const handlePasswordSubmit = (e) => {
        e.preventDefault();
        if (password.toUpperCase() === SECRET_CODE) {
            setError(false); setStage('scene2');
        } else {
            setError(true); setTimeout(() => setError(false), 2000);
        }
    };

    const handleSecondDownload = () => {
        if (isCollecting) return;
        setIsCollecting(true);
        setTimeout(() => {
            const link = document.createElement('a');
            link.href = FILE_BONUS; 
            link.setAttribute('download', FILE_BONUS);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            setStage('closed');
            setIsPlaying(false);
            setIsCollecting(false);
            if(audioRef.current) {
                audioRef.current.pause();
                audioRef.current.currentTime = 0;
            }
        }, 1500);
    };

    return (
        <div className="scene-container">
            <style>{globalStyles}</style>
            <audio ref={audioRef} src={AUDIO_BGM} loop />

            <div className="immersive-bg" style={{ backgroundImage: `url(${currentBg})` }}></div>

            <div className="aspect-ratio-box float-book">
                <img src={IMG_CLOSED} className={`book-image ${stage === 'closed' ? 'opacity-100 cursor-pointer' : 'opacity-0 pointer-events-none'}`} onClick={handleStart} onError={(e) => console.error("Error cargando librocerrado.png")} />
                <img src={IMG_OPENING} className={`book-image ${stage === 'opening' ? 'opacity-100' : 'opacity-0 pointer-events-none'}`} onError={(e) => console.error("Error cargando libroabierto.png")} />
                <img src={IMG_OPEN_BOOK} className={`book-image ${['scene1','password','scene2'].includes(stage) ? 'opacity-100' : 'opacity-0 pointer-events-none'}`} onError={(e) => console.error("Error cargando libro.png")} />

                {stage !== 'closed' && <Sparkles />}

                {['scene1', 'password', 'scene2'].includes(stage) && (
                    <div className="book-grid animate-[fadeIn_1s_ease-out]">
                        
                        {stage === 'scene1' && (
                            <div className="col-span-2 flex flex-col items-center justify-center h-full">
                                <InvocationSpiral onClick={handleSpiralClick} isInvoking={isInvoking} />
                            </div>
                        )}

                        {stage === 'password' && (
                            <div className="col-span-2 flex items-center justify-center h-full">
                                <FullMagicSeal 
                                    password={password} 
                                    setPassword={setPassword} 
                                    onSubmit={handlePasswordSubmit} 
                                    error={error} 
                                />
                            </div>
                        )}

                        {stage === 'scene2' && (
                            <>
                                <div className="flex flex-col items-center justify-center text-center p-4">
                                    <div className="animate-[fadeIn_0.5s_ease-out]">
                                        <TreasureChest />
                                        <h3 className="text-4xl font-bold text-[#d63031] mt-2 font-serif drop-shadow-md">LEVEL UP!</h3>
                                    </div>
                                </div>
                                <div className="flex flex-col items-center justify-center text-center p-4">
                                    <div className="w-full h-full flex flex-col items-center justify-center">
                                        <h2 className="text-3xl mb-4 text-[#e91e63] font-bold">Â¡FINAL!</h2>
                                        <div className="bg-pink-100 border-2 border-[#e91e63] p-3 mb-6 shadow rotate-[-1deg] w-full max-w-xs">
                                            <p className="font-bold text-[#880e4f] text-sm">â™« BGM: Circle of Love</p>
                                            <TypewriterText text="El viaje continÃºa..." className="handwritten text-xs mt-1" delay={80}/>
                                        </div>
                                        <FinalSpiral onClick={handleSecondDownload} isCollecting={isCollecting} />
                                    </div>
                                </div>
                            </>
                        )}
                    </div>
                )}
            </div>

            {stage === 'closed' && (
                <div className="absolute bottom-12 animate-bounce z-50 pointer-events-none">
                    <span className="bg-black/60 text-white px-4 py-1 rounded-full text-sm font-bold backdrop-blur border border-white/50">
                        Haz clic para abrir el grimorio
                    </span>
                </div>
            )}
        </div>
    );
}
